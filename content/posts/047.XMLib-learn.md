---
title: "XMLibå­¦ä¹ ç¬”è®°"
date: 2021-09-22T11:19:31+08:00
draft: false
isCJKLanguage: true
---

## XMLibä»‹ç»

XMLibæ˜¯ä¸€ä¸ªåŠ¨ä½œæ¸¸æˆç¼–è¾‘å™¨

- é€å¸§åŠ¨ä½œç¼–è¾‘
- é€»è¾‘ä¸è¡¨ç°åˆ†ç¦»
- åŠ¨ä½œé€»è¾‘å®ç°ç®€å•
- å¯ç”¨äºå¸§åŒæ­¥
- æ”¯æŒ2Dä¸3D

> ğŸ’¡ Githubåœ°å€ï¼š[https://github.com/PxGame/XMLib.AM](https://github.com/PxGame/XMLib.AM)



## ç±»å›¾ï¼ˆMermaidï¼‰

```mermaid
classDiagram
classa --> classB
```



## æ‰§è¡Œé¡ºåº

- `GameManager`
  - `Awake()`ï¼šåŠ è½½æŠ€èƒ½ç¼–è¾‘å™¨çš„é…ç½®æ–‡ä»¶ï¼Œåˆå§‹åŒ–Inputæ•°æ®ç±»
  - `Update()`â€œï¼š
    - InputUpdateï¼šè¯»å–è¾“å…¥
    - LogicUpdateï¼šè¿™ä¸ªå‡½æ•°ç¡®ä¿äº†ä¸€ç§å¸§æ•°ç¨³å®šçš„Updateå®ç°
      - æ‰§è¡Œ`ActionMachineController.LogicUpdate`
      - ClearInputDataï¼šæ¸…ç©ºè¾“å…¥
  
- `ActionMachineController`
  
  - æŒ‚è½½åœ¨ä¸€ä¸ªPlayerçš„GameObjectä¸Šä½œä¸º
  - æŒ‡å®šé…ç½®æ–‡ä»¶
  - å¼•ç”¨animatorã€rigidBodyã€modelã€rotateSpeedç­‰åŸºç¡€ä¿¡æ¯
  - å¼•ç”¨ä¸€ä¸ª`IActionMachine`ï¼ˆå®é™…ä¸Šåªæœ‰ä¸€ä¸ª`ActionMachine`å®ç°äº†è¿™ä¸ªæ¥å£ï¼‰
  - `Start()`ï¼š
    - åˆå§‹åŒ–`(IActionMachine) actionMachine`
    - æ ¹æ®`actionMachine`åˆå§‹åŒ–æ’­æ”¾çš„åŠ¨ç”»
    - åˆå§‹åŒ–å…¶ä»–æ•°æ®
  - `Update()`ï¼š
    - `UpdateAnimation()`ï¼šæ ¹æ®ä¸€ä¸ªtimerä¸é€»è¾‘å¸§åŒæ­¥æ’­æ”¾åŠ¨ç”»çš„å®ç°
    - `UpdateRotation()`ï¼šæ ¹æ®æ—‹è½¬çš„é€Ÿåº¦æ¥é¡ºæ»‘çš„æ’­æ”¾æ¨¡å‹çš„æ—‹è½¬
  - `LogicUpdate()`ï¼š
    - é€»è¾‘Updateï¼Œä¾›`GameManager`ç»Ÿä¸€è°ƒç”¨
    - `actionMachine.LogicUpdate()`
    - `UpdateLogicAnimation()`ï¼šæ ¹æ®é€»è¾‘å¸§ä¸­å†™å…¥çš„`eventTypes`æ¥æ›´æ–°åŠ¨ç”»çš„æ’­æ”¾æ—¶é—´ï¼ˆå†åœ¨Updateä¸­æ›´æ–°åŠ¨ç”»çš„æ’­æ”¾ï¼‰ï¼Œä¸åŠ¨ç”»çš„åˆ‡æ¢èåˆ
    - `CheckGround()`
  
- `ActionMachine`

  - ğŸ’¡ è¿™ä¸æ˜¯ä¸€ä¸ª `Monobehaviour`

  - è¿™ä¸ªç±»æœ¬è´¨æ—¶ä¸€ä¸ªFSMï¼Œåªæ˜¯è¿™ä¸ªFSMçš„åˆ‡æ¢é©±åŠ¨éƒ½æ˜¯åŸºäºæ•°æ®çš„ï¼Œä¿å­˜åœ¨äº†configé‡Œï¼Œ

    > ä¸€ä¸ªconfig æœ‰å¤šä¸ª stateï¼Œstateä¹‹é—´çš„åˆ‡æ¢æœ‰é…ç½®çš„æ¡ä»¶è·³è½¬çš„ï¼Œæœ‰æœ€åä¸€å¸§å›åˆ°é»˜è®¤çŠ¶æ€çš„ç­‰ç­‰

  - æ ¹æ®å®å®šä¹‰usingåˆ°ä¸åŒçš„`Single`æ•°æ®ç±»å‹å’Œæ•°å­¦åº“

  - åˆå§‹åŒ–äº†å¾ˆå¤šçš„æ•°æ®ï¼ŒåŒ…æ‹¬é¡¿å¸§ä¿¡æ¯ã€MachineConfigã€StateConfigç­‰

  - åŒ…å«`ActionNode`ï¼Œåˆ†ä¸ºæ™®é€šçš„å’Œglobalçš„ï¼ˆglobalçš„ä¸å—é¡¿å¸§å½±å“ï¼‰

  - `LogicUpdate()`

    - `InitValue`ï¼šåˆå§‹åŒ–è§¦å‘çš„äº‹ä»¶ï¼Œè¿™ä¸ªäº‹ä»¶ä¹ŸåŸºæœ¬ä¸Šå°±åªæ˜¯è¡¨ç°å±‚çš„äº‹ä»¶åšæ’­æ”¾åŠ¨ç”»ç”¨

    - `UpdateState() & UpdateGlobelFrame()`

      > ä¸å—é¡¿å¸§å½±å“çš„`UpdateActions()`
      >
      > å…¶å®æˆ‘è§‰å¾— `UpdateFrame() & UpdateState()` ï¼Œè¿™æ ·è°ƒè½¬äº†ä¸€ä¸‹é¡ºåºåè€Œæ›´é€‚åˆä¸€äº›ï¼Œä¸‹åŒ

    - `UpdateState() & UpdateFrame()`

      > 

      

- `ActionNode`

  - ä¸€ä¸ªStateä¸­åŒ…å«å¤šä¸ªActionNodeï¼Œç›¸å½“äºä¸€ä¸ªä¸ªçš„æ¸¸æˆé€»è¾‘
  - `IActionMachine`ï¼Œå¯¹æ‰€å±FSMçš„å¼•ç”¨
  - `config`æ˜¯ä¸ªä»€ä¹ˆæ¦‚å¿µï¼Ÿå®ƒè¿˜åªæ˜¯ä¸€ä¸ªobjectç±»ï¼Œåˆ†ä¸º `IHodeFrames` `JumpConfig`ç­‰



### åŠ¨ç”»æ˜¯å¦‚ä½•æ’­æ”¾çš„

åœ¨`ActionMachineController` --> `Update()` --> `UpdateAnimation()` --> `Animator.Update()`

è¿™é‡Œä¸»åŠ¨çš„å»è°ƒç”¨`Animator.Update()`ï¼Œå¹¶ä¸”åŒæ—¶æŠŠ`Animator`è¿™ä¸ªç»„ä»¶ç½®ä¸ºDisableï¼ˆå…¶å®å¯ä»¥ç”¨Animancerä»£æ›¿ï¼Œæ„Ÿè§‰æ›´å¥½ï¼Ÿï¼‰

### å¦‚ä½•ä¿è¯åŠ¨ç”»çš„æ’­æ”¾ä¸é€»è¾‘è¡¨ç°ä¸€è‡´

åœ¨ä¸»åŠ¨è°ƒç”¨`Animator.Update()`çš„æ—¶å€™æœ‰ä¸€ä¸ªæ¡ä»¶é™åˆ¶ï¼š

- åŠ¨ç”»çš„æ’­æ”¾ä¹Ÿåˆ†ä¸ºé€»è¾‘ä¸è¡¨ç°ï¼Œéƒ½åœ¨`ActionMachineController`ç±»ä¸­
- æ¯ä¸ªé€»è¾‘å¸§éƒ½å¢åŠ `animatorTimer`ï¼Œå«ä¹‰ä¸ºåŠ¨ç”»çš„é€»è¾‘timer
- æ’­æ”¾åŠ¨ç”»çš„è„šæœ¬åªåœ¨`animatorTimer`æœ‰å€¼çš„æ—¶å€™æ‰ä¼šæ‰§è¡Œ`Animator.Update()`

### é¡¿å¸§æ˜¯å¦‚ä½•å®ç°çš„

> ğŸ’¡ å…³äºä¸ºä»€ä¹ˆä¼šæœ‰GlobalActionsä¸å—é¡¿å¸§å½±å“ï¼ŒåŸä½œè€…è¡¨ç¤ºï¼Œå—ä¼¤å’ŒAIä¸åº”å½“å—é¡¿å¸§å½±å“

- å…³äºé¡¿å¸§åªéœ€è¦æŒ‡å®šé¡¿å¸§çš„å¼€å§‹æ—¶é—´å’Œé¡¿å¸§çš„æŒç»­æ—¶é—´ï¼Œç„¶ååœ¨UpdateFrameä¸­æœ‰è¿™æ ·ä¸€æ®µä»£ç 

```
if (waitFrameDelay > 0)
{
	waitFrameDelay--;
}
else if (waitFrameCnt > 0) //é¡¿å¸§
{ 
	waitFrameCnt--;
	return;
}

// ... ä¸šåŠ¡é€»è¾‘

// è¿™ä¸€æ®µè‡³å…³é‡è¦ï¼Œä¸Šé¢çš„returnå¯¼è‡´è¿™é‡Œä¸è¿è¡Œï¼Œç›´æ¥å†³å®šäº†é¡¿å¸§æ—¶åŠ¨ç”»ä¸ä¼šæ’­æ”¾ï¼Œ
// æœ‰ä¼˜åŒ–ç©ºé—´ï¼Œå¯ä»¥åœ¨é¡¿å¸§returnæ—¶ä½¿å¾—åŠ¨ç”»æœ‰è½»å¾®æŠ–åŠ¨
eventTypes |= ActionMachineEvent.FrameChanged;
```

