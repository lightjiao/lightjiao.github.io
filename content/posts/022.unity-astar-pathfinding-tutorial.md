---
title: "Unity A* Pathfindingï¼šTutorial çºªè¦"
date: 2020-12-03T18:41:35+08:00
draft: true
isCJKLanguage: true
tags:
 - Unity
---


åŸæ–‡é“¾æ¥ï¼šhttps://arongranberg.com/astar/docs/getstarted.html

- ä¸€ä¸ªå•ç‹¬çš„`Pathfinder`çš„Componentç”¨æ¥åšè®¾ç½®ï¼šå¯»è·¯çš„æ ¼å­çš„å½¢çŠ¶ç­‰

  > å…³äºè®¾ç½®å¿½ç•¥çš„å±‚çº§å’Œè®¾ç½®éšœç¢ç‰©ï¼š
  >
  > ç‚¹å‡»scanæŒ‰é’®çš„æ—¶å€™ï¼Œæ˜¯ä»ä¸Šå¾€ä¸‹å‘å°„å°„çº¿æ£€æŸ¥ç¢°æ’åˆ°äº†å“ªäº›ç‰©ä½“ï¼Œåˆ©ç”¨äº†unityçš„ç‰©ç†å¼•æ“å’Œcolliderç»„ä»¶ï¼Œå°†å¯»è·¯çš„èŠ‚ç‚¹ï¼ˆnodesï¼‰æ”¾ç½®åœ¨è¿™äº›å‡»ä¸­çš„ç‚¹ä¸Šã€‚
  >
  > é‚£ä¹ˆå¦‚ä½•è®¾ç½®éšœç¢ç‰©å’Œå¿½ç•¥çš„ç‰©ä½“å‘¢ï¼Ÿ
  >
  > - Graphs --> Height testing --> Mask: è¿™ä¸ªè®¾ç½®çš„ä½œç”¨æ˜¯å“ªäº›å±‚çº§ä¼šè¢«å‡»ä¸­ï¼Œé»˜è®¤åŒ…å«å…¨éƒ¨ï¼Œå¯ä»¥æŒ‡å®šå¿½ç•¥ï¼Œæ¯”å¦‚å¿½ç•¥åœºæ™¯ä¸­çš„Playerã€æœ‰ç¢°æ’ä½œç”¨ä½†å¯ä»¥ç©¿é€çš„é£ã€‚ï¼ˆä¹Ÿå¯ä»¥å½“ä¸åƒè®©éšœç¢ç‰©çš„é¡¶ç«¯å¯ä»¥è¡Œèµ°çš„æ—¶å€™å°†éšœç¢ç‰©å±‚çº§åŠ å…¥å¿½ç•¥ï¼Œå†æŠŠéšœç¢ç‰©åŠ å…¥åˆ°éšœç¢ç‰©å±‚çº§ï¼‰
  > - Graphs --> Collision testing --> Obstacle Layer Mask:è®¾ç½®éšœç¢ç‰©å±‚çº§ï¼Œè¿™äº›ç‰©å“çš„èŠ‚ç‚¹å°±æ˜¯éšœç¢ç‰©èŠ‚ç‚¹

- æ€ªç‰©ï¼ˆagentï¼‰èº«ä¸ŠåŒ…å«`Seaker`å’Œ`AIPath`ä¸¤ä¸ªComponentï¼ˆæ–°ç‰ˆæœ¬æ·»åŠ äº†ä¸€ä¸ª`AIDestinationSetter`ä»`AIPath`ä¸­å‰¥ç¦»å‡ºæ¥çš„è®¾ç½®å¯»è·¯ç›®æ ‡çš„Componentï¼‰

  > - `Seaker`çš„ä½œç”¨ï¼šè¾…åŠ©ä½œç”¨ï¼Œåœ¨åœ°å›¾ä¸Šç”»å‡ºä¸€äº› Gizmos ç­‰
  >
  > - `AIPath`æ˜¯å¯»è·¯çš„æœ¬ä½“ï¼ŒåŒ…å«å¯»è·¯å’Œç§»åŠ¨agentï¼Œå½“ç„¶å®ƒçš„å‚æ•°æœ‰å¾ˆå¤šå¾ˆå¤šâ€¦â€¦
  >
  > > åœ¨å¯»è·¯å¥½çš„è·¯å¾„ä¸Šç§»åŠ¨çš„æ—¶å€™ï¼Œæ”¯æŒæŒ‡å®šä¸€ä¸ªradiusï¼Œæ¯æ¬¡ç§»åŠ¨çš„æ—¶å€™ï¼Œä¼šç›´æ¥å¾€è¿™ä¸ªradiusä¸pathçš„äº¤ç•Œç‚¹ä¸Šç§»åŠ¨ï¼Œè€Œä¸æ˜¯æœºæ¢°çš„æ²¿ç€pathç§»åŠ¨ï¼ˆè¿™ä¸ªradiuså¦‚æœå¤ªå¤§çš„è¯ï¼Œä¼šé€ æˆæ‹è§’å¤„ç©¿æ¨¡ï¼‰

- æ”¯æŒæ·»åŠ å¯¹è·¯å¾„çš„Modifierè„šæœ¬

  > æ¯”å¦‚å…¶ä¸­çš„`RaycastModifier`ä¼šå°†å¯ä»¥å°†ä¸­é—´æ²¡æœ‰colliderçš„ä¸¤ä¸ªç‚¹ç›´æ¥è¿èµ·æ¥ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º
  >
  > æ”¯æŒæŒ‡å®šraycastçš„ç¢°æ’å±‚ã€raycastçš„radiusã€åç§»ä½ç½®è®©agentå°½å¯èƒ½çš„é¿å¼€éšœç¢ç‰©
  >
  > è¿˜æœ‰å¦å¤–çš„Graph Raycastingé€‰é¡¹æ¥ä»£æ›¿ç‰©ç†çš„raycast

<center class="half">
    <img src="./img/image-20201203121715298.png" width="400"/><img src="./img/QQæˆªå›¾20201203121836.png" width="400"/>
</center>




æ”¯æŒæŒ‡å®šè·¯å¾„çš„smoothï¼Œæœ‰ä¸€ä¸ªå•ç‹¬çš„smoothç»„ä»¶ï¼Œè®©å¯»æ‰¾å‡ºæ¥çš„è·¯å¾„ä»ä¸€ä¸ªä¸ªæ ¼å­çš„ç»„æˆï¼Œå°†ä¸ä¼šç¢°æ’åˆ°éšœç¢ç‰©çš„ä¸¤ç‚¹è¿èµ·æ¥ç›´çº¿ï¼Œè¿™ä¸ªè¿˜æ”¯æŒè¿çº¿çš„ç²—ç»†ï¼Œå¯ä»¥å°½å¯èƒ½çš„é¿å…éšœç¢ç‰©

![image-20201202203127709](D:/OneDrive/NervousTree/img/image-20201202203127709.png)



### Writing a movement script.

> We are going to write our own, really simple script for moving the AI, so open your favourite script-editor and follow.

é¦–å…ˆè¦åšçš„äº‹æƒ…å°±æ˜¯è®¡ç®—pathï¼Œæˆ‘ä»¬ç”¨`Seeker`ç»„ä»¶çš„`StartPath`æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•æ¥å—ä¸‰ä¸ªå‚æ•°ï¼šèµ·ç‚¹ã€ç»ˆç‚¹å’Œå›è°ƒå‡½æ•°ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼š

```c#
using UnityEngine;
using System.Collections;
// Note this line, if it is left out, the script won't know that the class 'Path' exists and it will throw compiler errors
// This line should always be present at the top of scripts which use pathfinding
using Pathfinding;

public class AstarAI : MonoBehaviour {
    public Transform targetPosition;

    public void Start () {
        // Get a reference to the Seeker component we added earlier
        Seeker seeker = GetComponent<Seeker>();

        // Start to calculate a new path to the targetPosition object, return the result to the OnPathComplete method.
        // Path requests are asynchronous, so when the OnPathComplete method is called depends on how long it
        // takes to calculate the path. Usually it is called the next frame.
        seeker.StartPath(transform.position, targetPosition.position, OnPathComplete);
    }

    public void OnPathComplete (Path p) {
        Debug.Log("Yay, we got a path back. Did it have an error? " + p.error);
    }
} 
```

å°†è¿™ä¸ªè„šæœ¬å‘½åä¸º`AstarAI.cs`æ·»åŠ åˆ°`AI`GameObjectä¸­ï¼Œå†åˆ›å»ºä¸€ä¸ªå…¶ä»–çš„GameObjectä½œä¸ºtarget

##### é‚£ä¹ˆ`Seeker`çš„`StartPath`æ–¹æ³•å‘ç”Ÿäº†ä»€ä¹ˆå‘¢ï¼Ÿ

seekerä¼šåˆ›å»ºä¸€ä¸ª`ABPath`å®ä¾‹ï¼Œå†å°†è¿™ä¸ªå®ä¾‹å‘é€åˆ°`AstarPath`è„šæœ¬ä¸­ï¼ˆåªæ˜¯é™æ€æ–¹æ³•å•¦~ï¼‰ï¼Œ`AstarPath`è„šæœ¬ä¼šå°†pathæ”¾å…¥åˆ°é˜Ÿåˆ—ï¼Œç„¶åå°½å¯èƒ½å¿«çš„å¤„ç†è¿™ä¸ªpathï¼Œä¸€ä¸ªèŠ‚ç‚¹ä¸€ä¸ªèŠ‚ç‚¹çš„æœç´¢gridï¼Œç›´è‡³æœç´¢åˆ°ç»ˆç‚¹ã€‚å…·ä½“çš„å®ç°å°±æ˜¯A*ç®—æ³•ã€‚

ï¼ˆå…ˆä¼šè°ƒç”¨`Modifier`çš„é¢„å¤„ç†ï¼‰ä¸€æ—¦è®¡ç®—å®Œæˆï¼Œpathä¼šè¢«è¿”å›åˆ°`Seeker`ï¼Œè¢«è°ƒç”¨`Modifier`åšåå¤„ç†ï¼ˆå¦‚æœæœ‰æ·»åŠ `Modifer`çš„è¯ï¼‰ï¼Œå›è°ƒæ˜¯ä»¥æ·»åŠ åˆ°pathå˜é‡ä¸­çš„å›è°ƒå®ç°çš„ã€‚

å…³äºå›è°ƒï¼Œä¹Ÿå¯ä»¥ç›´æ¥

```csharp
seeker.pathCallback += SomeCallback;
seeker.pathCallback -= SomeCallback; // è®°å¾—åœ¨OnDisableçš„æ—¶å€™
```

---

> `Path`ç±»æ˜¯ä¸€ä¸ªå¸¦ `next`æŒ‡é’ˆçš„é“¾è¡¨èŠ‚ç‚¹ï¼Œ`next`å±æ€§æ˜¯ä¸€ä¸ªå†…éƒ¨å±æ€§ï¼Œç”¨äºåœ¨æ’é˜Ÿè®¡ç®—çš„æ—¶å€™è®¿é—®ï¼Œä¸å¼€æ”¾å¤–éƒ¨è®¿é—®ã€‚

---

##### æˆ‘ä»¬è®¡ç®—å®Œäº†ä¸€ä¸ªpathï¼Œæˆ‘ä»¬å¦‚ä½•è·å¾—å®ƒçš„ä¿¡æ¯å‘¢ï¼Ÿ

`Path`çš„å®ä¾‹æœ‰ä¸¤ä¸ªåŒ…å«è¿™äº›ä¿¡æ¯çš„list

`Path.vectorPath` æ˜¯ä¸€ä¸ª`Vector3`åˆ—è¡¨çš„å½¢å¼è¡¨è¾¾çš„è·¯å¾„ï¼Œè¿™ä¸ªåˆ—è¡¨ä¼šè¢«`Modifier`ä¿®æ”¹ï¼Œè¿™ä¸ªåˆ—è¡¨ä¹Ÿæ˜¯æ¨èçš„è·å–è·¯å¾„ä¿¡æ¯çš„æ–¹å¼ã€‚

`Path.path`åˆ—è¡¨æ˜¯ä¸€ä¸ª`GraphNode`å…ƒç´ çš„åˆ—è¡¨ï¼Œå®ƒä¿å­˜äº†æ‰€è®¿é—®è·¯å¾„çš„æ‰€æœ‰èŠ‚ç‚¹ï¼Œè¿™å¯¹äºè·å–éå†è·¯å¾„ä¸Šçš„é™„åŠ ä¿¡æ¯å¾ˆæœ‰ç”¨ã€‚

ä½†æ˜¯ï¼Œé¦–å…ˆï¼Œä½ åº”å½“æ£€æŸ¥`path.error`ï¼Œå¦‚æœæ˜¯trueï¼Œé‚£ä¹ˆè¿™ä¸ªè·¯å¾„å°±å› ä¸ºæŸç§åŸå› å¤±è´¥äº†ï¼Œ`Path.errorlog`ä¼šæœ‰è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯ã€‚



##### æˆ‘ä»¬ç»™æˆ‘ä»¬çš„AIè„šæœ¬æ·»åŠ ä¸€äº›ç§»åŠ¨è¡Œä¸ºå§ï¼

â— 3Dï¼š

> æˆ‘ä»¬ç”¨Unityå†…ç½®çš„[`CharacterController`](https://docs.unity3d.com/ScriptReference/CharacterController.html)æ¥æ§åˆ¶agentï¼Œæ‰€ä»¥è®°å¾—ç»™AI GameObjectæ·»åŠ ä¸€ä¸ª`CharacterController`

â— 2Dï¼š

> æˆ‘ä»¬å°±ç®€å•çš„é€šè¿‡[Transform component](https://docs.unity3d.com/ScriptReference/Transform.html)æ¥ä¿®æ”¹agentçš„ä½ç½®

è¿™ä¸ªè„šæœ¬å°†è·Ÿè¸ªå®ƒæ‰€å‰è¿›çš„è·¯å¾„ä¸­çš„èˆªç‚¹ï¼ˆwaypointï¼‰ï¼Œå¹¶ä¸”æ¥è¿‘å…¶ä¸­ä¸€ä¸ªèˆªç‚¹çš„æ—¶å€™ï¼Œå°†è·Ÿè¸ªçš„èˆªç”µæ”¹ä¸ºä¸‹ä¸€ä¸ªã€‚

æ¯ä¸€å¸§ï¼Œæˆ‘ä»¬ä¼šåšä¸‹é¢è¿™å‡ ä»¶äº‹æƒ…ï¼š

- é¦–å…ˆï¼Œæ£€æŸ¥æ˜¯å¦æœ‰è®¡ç®—å¥½çš„pathå¯ä»¥è·Ÿéšã€‚ç”±äºpathçš„è¯·æ±‚æ˜¯å¼‚æ­¥çš„ï¼Œå› æ­¤ä¼šèŠ±è´¹å‡ å¸§ï¼ˆå¾€å¾€æ˜¯ä¸€å¸§ï¼‰çš„æ—¶é—´è·¯å¾„æ‰ä¼šè®¡ç®—å®Œæˆã€‚
- ç„¶åï¼Œæ£€æŸ¥agentæ˜¯å¦æ¥è¿‘å½“å‰æ­£åœ¨å‰è¿›çš„èˆªç‚¹ï¼ˆwaypointï¼‰ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™åˆ‡æ¢åˆ°èˆªç‚¹ï¼Œå¹¶é‡å¤æ£€æŸ¥ï¼ˆand repeat the check. æ˜¯æŒ‡å“ªä¸ªï¼Ÿï¼Ÿï¼ŸğŸ˜‚ï¼‰
- è·å–å½“å‰èˆªç‚¹ï¼ˆwaypointï¼‰çš„åæ ‡å‡å»æˆ‘ä»¬çš„ä½ç½®æ¥è®¡ç®—æˆ‘ä»¬å¦‚ä½•ç§»åŠ¨ã€‚è¿™ä¼šè·å¾—ä¸€ä¸ªæŒ‡å‘èˆªç‚¹çš„å‘é‡ï¼Œæˆ‘ä»¬å°†è¿™ä¸ªå‘é‡å½’ä¸€åŒ–ä½¿å¾—é•¿åº¦ä¸º1ï¼Œä¸ç„¶çš„è¯æˆ‘ä»¬ç¦»èˆªç‚¹è¶Šè¿œå°±ç§»åŠ¨å¾—è¶Šå¿«ã€‚
- å°†ä¸Šè¿°å¾—å‘é‡å’Œé€Ÿåº¦ï¼ˆæ ‡é‡ï¼‰ç›¸ä¹˜æ¥è·å–é€Ÿåº¦å¾—å‘é‡ã€‚
- æœ€åï¼Œç”¨`CharacterController.SimpleMove`æ–¹æ³•æ¥ç§»åŠ¨agentï¼ˆ2Då°±æ˜¯ç›´æ¥ä¿®æ”¹`transform.position`ï¼‰

> ä»£ç ç•¥

