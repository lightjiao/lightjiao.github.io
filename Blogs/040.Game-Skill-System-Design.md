---
title: "❗❗记录开发过程中遇到的技能系统的特殊情况"
date: 2021-06-22T12:48:10+08:00
draft: false
isCJKLanguage: true
tags:
- GameDev
---

## 关于网络同步

-  `LerpUnclamped()`可以做简单的影子跟随算法预测，方便取用

## Update()

- 服务器的 tick 时间如果按照 0.033 作为一帧的话，那么 1 秒就不是严格的 30 帧，而是 30.3030303030 帧
  - 这会导致这样一个现象：创建一个间隔 0.1s 的重复任务 A，和间隔 0.2s 的重复任务 B，这两个任务的执行顺序不会是严格的 AABAAB，而是类似于 AABAAB**A**BAAB
  - 在一秒的最后一帧时间补充一个 0.034，保证 1 秒一定 30 帧
  - 异步重复任务在重复执行的时候，不是直接 `gameTime + repeatTime`作为执行时间入队，而是 `invokeTime + repeatTime`这样来规避帧数带来的时间影响

## PhysX

- Unity 的 Collider 在 Destroy 或者 disable 的时候（对应PhysX里都是destroy），不会对进入它的 collider 发 `OnTriggerExit()` 事件
  - 手动实现 collider 和 trigger 的销毁时的逻辑
  - 改用 `OnTriggerStay()` 函数来实现相关逻辑


## 子弹

- 对象池 + 预加载 + 数据（物理）与表现分离，表现部分异步加载

- 子弹的奇奇怪怪的运动轨迹：直线、抛物线（贝塞尔模拟）、正弦
- 施法者死亡的时候子弹依旧造成伤害：
  - 施法者死亡，不代表施法者的实例要被销毁
  - 释放出去那一刻对施法者的属性做快照记录到子弹里

## Buff
- Buff 叠加时的伤害来源区分问题：A与B都对C施加了伤害Buff，要分别对A和B记录伤害summary
- 由于Buff添加Buff、Buff创建子弹、子弹添加Buff、子弹创建子弹，所以出现了获取最原始数据的需求
  - 这里最好能改成所有的Buff和子弹全都有Skill触发，Skill为唯一的核心
  
- Buff的Update最好不要使用零散的Timer，使用统一的一个Update来执行，可以统一处理执行顺序问题
- 两个Buff互相监听属性的修改问题：Buff A的功能是每当有1【HP】增加1【攻击力】  ，Buff B的功能是每当有1【攻击力】增加1【HP】  
  - 区分原本属性，与加成属性
  - 砍掉这种需求（比如LOL内测版本有一个装备是血量加攻击力，后来删了）


## 技能

- 技能与人物状态机的状态是什么关系？
- 边走边攻击：
  - 假设我们的人物只是一个Capsule（没有动画表现），攻击时就只是按照攻速产生子弹。
  - 这里的攻击行为，可以抽象为人物进入了一个状态 + 状态冷却，进入状态（产生子弹）-->冷却状态，状态的冷却可以由攻速决定。
  - 这个状态就可以被抽象为【技能】，我们当然可以一边移动人物一边释放这个技能。
  - 此时加上动画的表现如何呢，假设是一个大炮攻击，攻速很慢，并且冷却时间蛮长的。也就是预期是这样一个流程：释放技能（举起大炮-->产生子弹）-->冷却技能。
  - 加入了动画的表现后，就希望释放技能时，播放举起大炮的动画，以及在举起大炮后产生子弹（即在技能的某一帧产生子弹），而不是释放技能就立刻产生子弹
  - 此时如果加入了边走边释放技能呢？甚至跳跃起来释放技能呢？要知道跳跃和走路都是由动画表现的
  - 再做一层抽象：释放技能（技能前摇-->产生子弹）-->冷却技能。
  - 至于这个前摇的动画表现怎样，参照永劫无间的实现，可以由人物身上拥有的tag来决定，比如：技能释放中 + 行走 = 边走边攻击，动画表现上则需要分层动画+动画融合行走的动画与释放这个技能的动画
  - 有一些技能动画需要全身配合的，则可以限制此时人物不可以移动，然后播放一个全身的动画，以避免出现技能动画与移动动画融合起来很怪异的问题
- 一个技能有多个阶段，并且阶段的时长不固定，此时需要知道技能的生命周期：
  - 具体的例子：
    - 阶段一：向前冲锋一定距离，但碰到墙壁会停下来。不过冲锋时间最短`0.2s`，避免贴墙发动时表现为立刻进入第二阶段。
    - 阶段二：遇到墙壁停下来或者冲锋到极限距离后停下来时，释放一个原地的范围伤害，可以表现为踩踏。
  - 此时技能时长和范围是不固定的，需要动态的获取技能的生命周期（开始、状态转换、结束等）
- 蓄力技能，以及蓄力技能的指示器

  - 蓄力技能分两种情况：

    - 情况一：按下蓄力，松开结束蓄力
    - 情况二：点击一次进入蓄力状态，再点击一次释放技能。这种其实本质上不是蓄力技能，而是切换了两个技能的使用：先释放技能A，再释放技能B。
  - 这里只讨论情况一：
  
    - 蓄力时给自己施加一个蓄力Buff，这个Buff对`UI`做一些展示，或者施加一些特效
    - 蓄力时如果可以旋转方向，该要如何抽象呢。从`ECS`角度分析：
  
- 技能冷却的逻辑：
  - 一般的技能释放后即进入冷却
  - 举例一个特殊的：
    - 释放技能A后，将普攻变为另一个技能，并且技能A变为不可用状态
    - 普攻释放之后，技能A才进入冷却
  - 如果有这种需求，则需要抽象出【技能类型】的概念

- 技能Timeline

  一个技能往往需要在Timeline上编辑，有的时候一个技能会有动态的时长逻辑

  我们的做法是把一个技能拆分成多个技能来实现，但这样拆分了技能的逻辑，逻辑配置也麻烦

  但从逻辑上说，他们都是同一个技能，感觉可以使得一个技能有多个Timeline，这样只要支持Timeline之间的跳转就可以支持技能的动态时长的逻辑了
